<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>WANG WANG | ÂøòÂøò‰ªôË≤ù</title>
    <!-- ÂºïÂÖ•ÂúñÊ®ôËàáÂÑ™ÈõÖÂ≠óÈ´î -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Noto+Serif+TC:wght@300;400&family=Lato:wght@300;400&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- ÂÆöÁæ©Ëâ≤ÂΩ©ËÆäÊï∏ (È†êË®≠Ê∑±Ëâ≤Ê®°Âºè Dark Mode) --- */
      :root {
        --bg-body: #050505;
        --bg-card: #111111;
        --text-gold: #d4af37;
        --text-dim: #6c6c6c;
        --text-light: #e0e0e0;
        --text-contrast: #e0e0e0; /* Áî®Êñº‰∏ªË¶ÅÊ®ôÈ°å */
        --border-color: #222222;
        --switch-track: #000000;
        --switch-knob: #444444;
        --switch-active: #d4af37;
        --modal-bg: #111111;
        --btn-bg: rgba(5, 5, 5, 0.9);
        --input-bg: transparent;
        --shadow-color: rgba(0, 0, 0, 0.5);
        --accent-red: #800020;
        --glow-gold: 0 0 15px rgba(212, 175, 55, 0.2);
        --gradient-overlay: radial-gradient(
          circle at 50% 0%,
          #1a1a1a 0%,
          #000000 80%
        );
      }

      /* --- ‰∫ÆËâ≤Ê®°ÂºèËÆäÊï∏ (Light Mode) --- */
      [data-theme="light"] {
        --bg-body: #f9f9f9;
        --bg-card: #ffffff;
        --text-gold: #b8860b; /* Ê∑±ÈáëËâ≤ÔºåÂú®ÁôΩÂ∫ïÊõ¥Ê∏ÖÊ•ö */
        --text-dim: #888888;
        --text-light: #333333;
        --text-contrast: #1a1a1a;
        --border-color: #e0e0e0;
        --switch-track: #e0e0e0;
        --switch-knob: #ffffff;
        --switch-active: #b8860b;
        --modal-bg: #ffffff;
        --btn-bg: rgba(255, 255, 255, 0.9);
        --input-bg: #f4f4f4;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --glow-gold: 0 0 10px rgba(184, 134, 11, 0.2);
        --gradient-overlay: radial-gradient(
          circle at 50% 0%,
          #ffffff 0%,
          #f0f0f0 80%
        );
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background-color: var(--bg-body);
        color: var(--text-gold);
        font-family: "Lato", sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background-image: var(--gradient-overlay);
        padding-bottom: 100px;
        transition: background 0.5s ease, color 0.5s ease;
      }

      /* --- Header & Logo --- */
      .header {
        text-align: center;
        padding: 50px 20px 30px;
        position: relative;
      }

      /* CSS Áπ™Ë£ΩË≤ùÊÆºÊÑüÊ∏¨Âô® Logo */
      .shell-logo {
        width: 60px;
        height: 60px;
        background: radial-gradient(
          circle at 30% 30%,
          #fff 0%,
          #ccc 40%,
          #888 100%
        );
        border-radius: 50%;
        margin: 0 auto 15px;
        box-shadow: 0 0 0 1px var(--border-color),
          0 0 30px rgba(255, 255, 255, 0.1);
        position: relative;
      }
      .shell-logo::after {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border-radius: 50%;
        border: 1px solid rgba(212, 175, 55, 0.5);
        animation: pulse 3s infinite ease-in-out;
      }

      .brand-title {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        margin: 0;
        letter-spacing: 3px;
        text-transform: uppercase;
        font-weight: 400;
        text-shadow: var(--glow-gold);
        color: var(--text-gold);
      }
      .brand-sub {
        font-family: "Noto Serif TC", serif;
        font-size: 0.8rem;
        color: var(--text-dim);
        letter-spacing: 5px;
        margin-top: 5px;
        opacity: 0.8;
      }

      .settings-btn {
        position: absolute;
        top: 40px;
        right: 20px;
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-dim);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      .settings-btn:hover {
        border-color: var(--text-gold);
        color: var(--text-gold);
      }

      /* --- List Items --- */
      .menu-list {
        padding: 0 20px;
        max-width: 600px;
        margin: 0 auto;
      }
      .menu-title {
        font-family: "Playfair Display", serif;
        color: var(--text-dim);
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 20px;
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      .item-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        padding: 25px 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: 0.3s;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 10px var(--shadow-color);
      }

      .item-card.active {
        border-color: var(--border-color);
        box-shadow: 0 5px 20px var(--shadow-color);
      }
      .item-card.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--text-gold);
        box-shadow: 0 0 10px var(--text-gold);
      }

      .item-info {
        flex-grow: 1;
        cursor: pointer;
      }
      .item-name {
        font-family: "Playfair Display", serif;
        font-size: 1.4rem;
        color: var(--text-dim);
        margin-bottom: 5px;
        transition: color 0.3s;
      }
      .item-card.active .item-name {
        color: var(--text-light);
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
      }

      .item-meta {
        font-size: 0.8rem;
        color: var(--text-dim);
        letter-spacing: 1px;
      }
      .item-card.active .item-meta {
        color: var(--text-gold);
      }

      /* --- Switch Toggle --- */
      .candle-switch {
        position: relative;
        width: 50px;
        height: 28px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .candle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--switch-track);
        border: 1px solid var(--border-color);
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: var(--switch-knob);
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      input:checked + .slider {
        border-color: var(--text-gold);
        background: var(--bg-card);
      }
      input:checked + .slider:before {
        transform: translateX(22px);
        background-color: var(--switch-active);
        box-shadow: 0 0 10px var(--switch-active);
      }

      /* --- FAB Buttons --- */
      .fab-container {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 100;
      }
      .btn-gold {
        background: var(--btn-bg);
        color: var(--text-gold);
        border: 1px solid var(--text-gold);
        padding: 12px 25px;
        font-family: "Playfair Display", serif;
        letter-spacing: 1px;
        cursor: pointer;
        text-transform: uppercase;
        font-size: 0.8rem;
        backdrop-filter: blur(5px);
        transition: 0.3s;
        border-radius: 30px;
        box-shadow: 0 5px 15px var(--shadow-color);
      }
      .btn-gold:hover {
        background: var(--text-gold);
        color: var(--bg-card);
      }
      .btn-gold.primary {
        background: rgba(212, 175, 55, 0.15);
      }
      [data-theme="light"] .btn-gold.primary {
        background: rgba(184, 134, 11, 0.1);
      }

      /* --- Modal --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .modal-overlay.show {
        opacity: 1;
      }

      .modal-box {
        background: var(--modal-bg);
        width: 85%;
        max-width: 400px;
        border: 1px solid var(--border-color);
        padding: 40px 30px;
        text-align: center;
        position: relative;
        box-shadow: 0 20px 50px var(--shadow-color);
      }
      .modal-box::after {
        content: "";
        position: absolute;
        top: 5px;
        left: 5px;
        right: 5px;
        bottom: 5px;
        border: 1px solid var(--border-color);
        pointer-events: none;
      }

      .modal-title {
        font-family: "Playfair Display", serif;
        font-size: 1.5rem;
        margin-bottom: 30px;
        font-style: italic;
        color: var(--text-gold);
      }

      .input-gold {
        background: var(--input-bg);
        border: none;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
        padding: 10px 0;
        color: var(--text-light);
        text-align: center;
        margin-bottom: 25px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
      }
      .input-gold:focus {
        border-bottom-color: var(--text-gold);
      }

      /* ‰øÆÊîπ Placeholder Ëàá Disabled Ê®£Âºè */
      .input-gold:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        border-bottom: 1px dashed var(--text-dim);
        color: var(--text-dim);
        font-style: italic;
      }
      .input-gold::placeholder {
        color: var(--text-dim);
        opacity: 0.6;
      }

      .label-small {
        font-size: 0.6rem;
        color: var(--text-gold);
        display: block;
        margin-bottom: 5px;
        letter-spacing: 2px;
        opacity: 0.7;
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 10;
      }
      .close-btn:hover {
        color: var(--text-gold);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="shell-logo"></div>
      <h1 class="brand-title">WANG WANG</h1>
      <div class="brand-sub">ÂøòÂøò‰ªôË≤ù</div>
      <button class="settings-btn" onclick="openSettings()">
        <i class="bi bi-gear"></i>
      </button>
    </header>

    <div class="menu-list">
      <div class="menu-title">Memory Menu</div>
      <div id="itemContainer"></div>

      <div
        style="
          text-align: center;
          margin-top: 40px;
          font-size: 0.7rem;
          color: var(--text-dim);
          letter-spacing: 2px;
        "
      >
        SYSTEM STATUS: <span id="statusText">checking...</span>
      </div>
    </div>

    <!-- Â∫ïÈÉ®ÊåâÈàïÂçÄ -->
    <div class="fab-container">
      <!-- 1. ÂàáÊèõÊ®°ÂºèÊåâÈàï (Âèñ‰ª£ÂéüÊú¨ÁöÑ Surprise) -->
      <button class="btn-gold" onclick="toggleTheme()">
        <i id="themeIcon" class="bi bi-sun-fill"></i> Mode
      </button>

      <!-- 2. Êñ∞Â¢ûÁâ©ÂìÅÊåâÈàï -->
      <button class="btn-gold primary" onclick="openEditor('new')">
        Add Course
      </button>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
      <div class="modal-box">
        <button class="close-btn" onclick="closeModal('editModal')">
          &times;
        </button>
        <h2 class="modal-title">Item Details</h2>
        <input type="hidden" id="editId" />

        <input
          type="text"
          class="input-gold"
          id="editName"
          placeholder="Item Name"
        />

        <!-- RFID Ê¨Ñ‰ΩçÔºöVVVIP Only -->
        <input
          type="text"
          class="input-gold"
          id="editMac"
          placeholder="RFID : VVVIP Only"
          disabled
        />

        <div style="display: flex; gap: 20px">
          <div style="flex: 1">
            <label class="label-small">FROM</label>
            <input type="time" class="input-gold" id="editStart" />
          </div>
          <div style="flex: 1">
            <label class="label-small">UNTIL</label>
            <input type="time" class="input-gold" id="editEnd" />
          </div>
        </div>

        <button
          class="btn-gold primary"
          style="width: 100%; margin-top: 10px"
          onclick="saveItem()"
        >
          Confirm
        </button>
        <button
          class="btn-gold"
          style="
            width: 100%;
            margin-top: 10px;
            border-color: var(--accent-red);
            color: var(--accent-red);
            background: transparent;
          "
          onclick="deleteItem()"
        >
          Remove
        </button>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal-box">
        <button class="close-btn" onclick="closeModal('settingsModal')">
          &times;
        </button>
        <h2 class="modal-title">WangWang Access</h2>

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
          "
        >
          <span
            style="
              color: var(--text-dim);
              font-size: 0.9rem;
              letter-spacing: 1px;
            "
            >Master Switch</span
          >
          <label class="candle-switch">
            <input
              type="checkbox"
              id="masterSwitch"
              onchange="saveSettings(false)"
            />
            <span class="slider"></span>
          </label>
        </div>

        <label class="label-small">LINE TOKEN</label>
        <input type="password" class="input-gold" id="lineToken" />
        <label class="label-small">USER ID</label>
        <input type="text" class="input-gold" id="lineUserId" />

        <!-- Ê®°Êì¨Ê∏¨Ë©¶ÊåâÈàïÁßªÂà∞Ë®≠ÂÆöÈ†ÅÈù¢ -->
        <button
          class="btn-gold"
          style="
            width: 100%;
            margin-bottom: 15px;
            margin-top: 15px;
            border-color: var(--text-dim);
            color: var(--text-dim);
            background: transparent;
          "
          onclick="triggerTest()"
        >
          Run Simulation Test
        </button>

        <button
          class="btn-gold primary"
          style="width: 100%"
          onclick="saveSettings(true)"
        >
          Save Configuration
        </button>
      </div>
    </div>

    <script>
      let appData = {
        system_enabled: true,
        items: [],
        line_token: "",
        line_user_id: "",
      };

      window.onload = function () {
        fetchData();
      };

      // --- ‰∏ªÈ°åÂàáÊèõÈÇèËºØ ---
      function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById("themeIcon");
        const currentTheme = body.getAttribute("data-theme");

        if (currentTheme === "light") {
          body.removeAttribute("data-theme");
          icon.className = "bi bi-sun-fill";
        } else {
          body.setAttribute("data-theme", "light");
          icon.className = "bi bi-moon-stars-fill";
        }
      }

      // --- API Ê∫ùÈÄö ---
      async function fetchData() {
        try {
          const res = await fetch("/api/data");
          if (res.ok) {
            appData = await res.json();
            renderUI();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function postData() {
        await fetch("/api/data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(appData),
        });
        fetchData();
      }

      // --- Áï´Èù¢Ê∏≤Êüì ---
      function renderUI() {
        const container = document.getElementById("itemContainer");
        container.innerHTML = "";

        appData.items.forEach((item, index) => {
          const activeClass = item.enabled ? "active" : "";
          const checked = item.enabled ? "checked" : "";

          const html = `
                    <div class="item-card ${activeClass}">
                        <div class="item-info" onclick="openEditor(${index})">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">
                                ${item.start_time} - ${item.end_time}
                            </div>
                        </div>
                        <label class="candle-switch">
                            <input type="checkbox" ${checked} onchange="toggleItem(${index})">
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
          container.insertAdjacentHTML("beforeend", html);
        });

        document.getElementById("masterSwitch").checked =
          appData.system_enabled;
        document.getElementById("statusText").innerText = appData.system_enabled
          ? "ONLINE"
          : "OFFLINE";
        document.getElementById("statusText").style.color =
          appData.system_enabled ? "#30D158" : "#800020";

        if (document.activeElement.id !== "lineToken")
          document.getElementById("lineToken").value = appData.line_token || "";
        if (document.activeElement.id !== "lineUserId")
          document.getElementById("lineUserId").value =
            appData.line_user_id || "";
      }

      function toggleItem(index) {
        appData.items[index].enabled = !appData.items[index].enabled;
        postData();
      }

      function openEditor(index) {
        const modal = document.getElementById("editModal");
        const idInput = document.getElementById("editId");

        // 3. VVVIP ÈôêÂà∂ÈÇèËºØ (Âè™ÂÖÅË®±1ÂÄã)
        if (index === "new" && appData.items.length >= 1) {
          alert(
            "üëë VVVIP Â∞äÁàµÁ¶ÆÈÅá üëë\n\n" +
              "ÊÇ®ÁõÆÂâçÁöÑ„ÄåÂÖ•ÈñÄÂìÅÈëëÁâà„ÄçÂÉÖÈôêÂñÆÂÄãÂøòÂøò‰ªôË≤ù„ÄÇ\n" +
              "Ê¨≤Ëß£ÈéñÔºåË´ãÂçáÁ¥öËá≥ VVVIP ÂÑ™ÊÉ†ÊñπÊ°àÔºÅ\n\n" +
              "ÔºàË´ãÊ¥ΩÂç°Âç°Ë≥ºË≤∑ÔºåÊàñÂÖàÂà™Èô§ËàäÈ†ÖÁõÆÔΩûÔºâ"
          );
          return;
        }

        if (index === "new") {
          idInput.value = "new";
          document.getElementById("editName").value = "";
          document.getElementById("editMac").value = "";
          document.getElementById("editStart").value = "08:00";
          document.getElementById("editEnd").value = "19:00";
        } else {
          idInput.value = index;
          const item = appData.items[index];
          document.getElementById("editName").value = item.name;
          document.getElementById("editMac").value = item.mac;
          document.getElementById("editStart").value = item.start_time;
          document.getElementById("editEnd").value = item.end_time;
        }
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);
      }

      function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }

      function saveItem() {
        const idx = document.getElementById("editId").value;
        const newItem = {
          id: idx === "new" ? "item_" + Date.now() : appData.items[idx].id,
          name: document.getElementById("editName").value,
          mac: document.getElementById("editMac").value,
          start_time: document.getElementById("editStart").value,
          end_time: document.getElementById("editEnd").value,
          enabled: true,
        };

        if (idx === "new") appData.items.push(newItem);
        else {
          newItem.enabled = appData.items[idx].enabled;
          appData.items[idx] = newItem;
        }
        postData();
        closeModal("editModal");
      }

      function deleteItem() {
        const idx = document.getElementById("editId").value;
        if (idx !== "new" && confirm("Remove this item?")) {
          appData.items.splice(idx, 1);
          postData();
        }
        closeModal("editModal");
      }

      function openSettings() {
        const modal = document.getElementById("settingsModal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);
      }

      function saveSettings(close = false) {
        appData.system_enabled =
          document.getElementById("masterSwitch").checked;
        appData.line_token = document.getElementById("lineToken").value;
        appData.line_user_id = document.getElementById("lineUserId").value;
        postData();
        if (close) closeModal("settingsModal");
      }

      function triggerTest() {
        fetch("/api/trigger", { method: "POST" })
          .then((res) => res.json())
          .then((data) => alert("Surprise Signal Sent!"));
      }
    </script>
  </body>
</html>
